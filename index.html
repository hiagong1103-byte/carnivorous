<script>
const PLANILHA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTsqDIhOoTibb56-QuExYbR9PfD1Fbu4y5x1a9k3X5BcLdl3rRA7tGmCQNI_Gn-uAlkYdUr1FtMigyA/pub?output=csv";

let listaProdutos = [];
const carrinho = {};

const produtosDiv = document.getElementById("produtos");
const carrinhoDiv = document.getElementById("carrinho");

Papa.parse(PLANILHA_URL, {
  download:true,
  skipEmptyLines:true,
  complete: function(res){
    listaProdutos = res.data
      .slice(1) // pula o cabeÃ§alho
      .map(l => {
        return {
          nome: l[1],      // Produto
          categoria: l[2], // Categoria
          preco: Number(
            String(l[3] || "")
              .replace("R$","")
              .replace(/\./g,"")
              .replace(",",".")
          )
        };
      })
      .filter(p => p.nome && p.categoria && p.preco > 0);

    carregarCategorias();
    renderizarProdutos();
  }
});

function carregarCategorias(){
  const cats=[...new Set(listaProdutos.map(p=>p.categoria))];
  filtroCategoria.innerHTML = `<option value="">Categorias</option>`;
  cats.forEach(c=>{
    filtroCategoria.innerHTML+=`<option value="${c}">${c}</option>`;
  });
}

function renderizarProdutos(lista = listaProdutos){
  produtosDiv.innerHTML="";
  const porCat={};

  lista.forEach(p=>{
    porCat[p.categoria]=porCat[p.categoria]||[];
    porCat[p.categoria].push(p);
  });

  for(const c in porCat){
    produtosDiv.innerHTML+=`<div class="categoria"><h2>${c}</h2></div>`;
    porCat[c].forEach(p=>{
      const id=p.nome.replace(/\W/g,"");
      produtosDiv.innerHTML+=`
      <div class="produto">
        <b>${p.nome}</b><br>
        R$ ${p.preco.toFixed(2)}
        <div class="controle">
          <button onclick="remover('${p.nome}')">âˆ’</button>
          <span id="qtd-${id}">0</span>
          <button onclick="adicionar('${p.nome}',${p.preco})">+</button>
        </div>
      </div>`;
    });
  }
}

function adicionar(nome,preco){
  carrinho[nome]=carrinho[nome]||{qtd:0,preco};
  carrinho[nome].qtd++;
  atualizar();
}

function remover(nome){
  if(!carrinho[nome])return;
  carrinho[nome].qtd--;
  if(carrinho[nome].qtd<=0) delete carrinho[nome];
  atualizar();
}

function atualizar(){
  let q=0,t=0;
  document.querySelectorAll('[id^="qtd-"]').forEach(e=>e.innerText=0);

  for(const i in carrinho){
    q+=carrinho[i].qtd;
    t+=carrinho[i].qtd*carrinho[i].preco;
    const s=document.getElementById("qtd-"+i.replace(/\W/g,""));
    if(s) s.innerText=carrinho[i].qtd;
  }

  qtdCarrinho.innerText=q;
  totalCarrinho.innerText="R$ "+t.toFixed(2);
}

function abrirCarrinho(){
  carrinhoDiv.style.display="block";
  listaCarrinho.innerHTML="";
  let t=0;

  for(const i in carrinho){
    const sub=carrinho[i].qtd*carrinho[i].preco;
    t+=sub;
    listaCarrinho.innerHTML+=`${i} x${carrinho[i].qtd} = R$ ${sub.toFixed(2)}<br>`;
  }

  totalFinal.innerText="TOTAL: R$ "+t.toFixed(2);
}

function fecharCarrinho(){
  carrinhoDiv.style.display="none";
}

function finalizarPedido(){
  let tipo = prompt("Entrega ou Retirada?");
  if(!tipo) return;
  tipo = tipo.toLowerCase();

  let entrega = tipo.includes("entrega");
  let endereco="";

  if(entrega){
    endereco = prompt("Informe o endereÃ§o completo:");
    if(!endereco) return;
    alert("âš ï¸ Cobramos taxa por KM.\nO valor serÃ¡ informado no WhatsApp.");
  }

  let pagamento = prompt("Forma de pagamento: DÃ©bito, CrÃ©dito, Vale ou Pix");
  if(!pagamento) return;

  let msg="ðŸ›’ Pedido Carnivorous%0A%0A";
  let total=0;

  for(const i in carrinho){
    const sub=carrinho[i].qtd*carrinho[i].preco;
    total+=sub;
    msg+=`${i}%0AQtd: ${carrinho[i].qtd}%0ASubtotal: R$ ${sub.toFixed(2)}%0A%0A`;
  }

  msg+=`TOTAL: R$ ${total.toFixed(2)}%0A`;
  msg+=entrega ? `ðŸ“ EndereÃ§o: ${endereco}%0A` : "ðŸª Retirada no local%0A";
  msg+=`ðŸ’³ Pagamento: ${pagamento}`;

  window.open(`https://wa.me/5511999562721?text=${msg}`);
}

function filtrarProdutos(){
  const t=busca.value.toLowerCase();
  const c=filtroCategoria.value;

  renderizarProdutos(listaProdutos.filter(p =>
    p.nome.toLowerCase().includes(t) &&
    (!c || p.categoria===c)
  ));
}
</script>
